# Решение проблемы инициализации контекста модели

**Дата:** 12.12.2025  
**Версия SDK:** 1.3.5  
**Проблема:** Ошибка "Context not available" при инициализации переменных контекста модели

## Описание проблемы

При попытке получить или установить переменную `V_MODEL_VARIABLES` в контексте модели через Remote API возникала ошибка **"Context not available"**. Это происходило при инициализации переменных контекста в методе `ProxyContext.initVariables()`.

### Причина

Контекст модели использует специальные переменные для работы через Remote API:
- `V_MODEL_VARIABLES` вместо стандартной `V_VARIABLES`
- `V_MODEL_FUNCTIONS` вместо стандартной `V_FUNCTIONS`
- `V_MODEL_EVENTS` вместо стандартной `V_EVENTS`

Стандартные переменные (`V_VARIABLES`, `V_FUNCTIONS`, `V_EVENTS`) могут быть недоступны для контекста модели через Remote API, что приводит к ошибке "Context not available".

## Решение

Реализована автоматическая обработка контекста модели в методах инициализации:

### 1. Метод `initVariables()`

- Сначала пытается получить стандартную переменную `V_VARIABLES`
- Если возникает ошибка "Context not available" и контекст является моделью, автоматически использует `V_MODEL_VARIABLES`
- Логирует переключение на специальную переменную для отладки

### 2. Метод `initFunctions()`

- Аналогично, сначала пытается получить `V_FUNCTIONS`
- При ошибке для контекста модели использует `V_MODEL_FUNCTIONS`

### 3. Метод `initEvents()`

- Аналогично, сначала пытается получить `V_EVENTS`
- При ошибке для контекста модели использует `V_MODEL_EVENTS`

### 4. Вспомогательный метод `isModelContext()`

Добавлен приватный метод для определения, является ли контекст моделью:
- Проверяет тип контекста через `getType()`
- Сравнивает с `Contexts.TYPE_MODEL` или `Contexts.TYPE_MODELS`
- Безопасно обрабатывает ошибки, возвращая `false` при невозможности определить тип

## Изменения в коде

### Файл: `ProxyContext.java`

1. **Добавлен импорт:**
   ```java
   import com.tibbo.aggregate.common.server.ModelContextConstants;
   ```

2. **Модифицирован метод `initVariables()`:**
   - Добавлена обработка ошибки "Context not available"
   - Автоматическое переключение на `V_MODEL_VARIABLES` для контекста модели

3. **Модифицирован метод `initFunctions()`:**
   - Добавлена обработка ошибки "Context not available"
   - Автоматическое переключение на `V_MODEL_FUNCTIONS` для контекста модели

4. **Модифицирован метод `initEvents()`:**
   - Добавлена обработка ошибки "Context not available"
   - Автоматическое переключение на `V_MODEL_EVENTS` для контекста модели

5. **Добавлен метод `isModelContext()`:**
   - Определяет тип контекста
   - Безопасно обрабатывает ошибки

## Преимущества решения

1. **Прозрачность:** Работает автоматически, без необходимости изменять код клиента
2. **Обратная совместимость:** Стандартные контексты продолжают работать как раньше
3. **Безопасность:** Ошибки обрабатываются корректно, не нарушая работу других контекстов
4. **Логирование:** Переключение на специальные переменные логируется для отладки

## Тестирование

### Сценарий 1: Стандартный контекст
- ✅ Стандартные переменные (`V_VARIABLES`, `V_FUNCTIONS`, `V_EVENTS`) работают как раньше
- ✅ Нет лишних попыток использовать переменные модели

### Сценарий 2: Контекст модели
- ✅ Автоматически определяется тип контекста
- ✅ При ошибке "Context not available" переключается на специальные переменные
- ✅ Успешно инициализируются переменные, функции и события

## Статус

✅ **ИСПРАВЛЕНО**

Код скомпилирован и готов к использованию. Проблема с инициализацией контекста модели решена.

## Следующие шаги

1. ✅ Исправление реализовано
2. ⏳ Требуется тестирование на реальном сервере AggreGate
3. ⏳ Проверка работы с различными типами контекстов модели

