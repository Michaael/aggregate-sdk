# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ AggreGate –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏

## üìä –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** 6.5/10  
**–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:** –í—ã—Å–æ–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏, –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞–ª–ª–æ–∫–∞—Ü–∏–∏, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±—É—Ñ–µ—Ä–æ–≤

## üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é

### 1. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞–ª–ª–æ–∫–∞—Ü–∏–∏ ByteArrayOutputStream

**–ü—Ä–æ–±–ª–µ–º–∞:**
```java
// AggreGateCommandParser.java:86
ByteArrayOutputStream stream = new ByteArrayOutputStream();
// CompressedCommandWriter.java:82
ByteArrayOutputStream stream = new ByteArrayOutputStream(commandLength);
```

**–í–ª–∏—è–Ω–∏–µ:**
- –ö–∞–∂–¥–∞—è –∫–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π `ByteArrayOutputStream`
- –ü—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ (1000+ –∫–æ–º–∞–Ω–¥/—Å–µ–∫) —ç—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:
  - –ß–∞—Å—Ç—ã–º GC –ø–∞—É–∑–∞–º
  - –§—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏
  - –£–≤–µ–ª–∏—á–µ–Ω–∏—é –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –Ω–∞ 20-30%

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É–ª –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö `ByteArrayOutputStream`
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ByteBuffer` —Å –ø—Ä—è–º—ã–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º –ø–∞–º—è—Ç–∏

### 2. Inflater –Ω–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞:**
```java
// AggreGateCommandParser.java:15
private Inflater decompressor = new Inflater();
```

**–í–ª–∏—è–Ω–∏–µ:**
- `Inflater` —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑, –Ω–æ –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –¥–æ–ª–∂–Ω—ã–º –æ–±—Ä–∞–∑–æ–º
- –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç `Deflater` (–∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `ThreadLocal`), `Inflater` –Ω–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –ø–æ –ø–æ—Ç–æ–∫–∞–º
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫ —É—Ç–µ—á–∫–∞–º –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏

**–†–µ—à–µ–Ω–∏–µ:**
```java
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ThreadLocal –∫–∞–∫ –≤ CompressedCommandWriter
private final ThreadLocal<Inflater> decompressor = 
    ThreadLocal.withInitial(Inflater::new);
```

### 3. –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤ –≤ OutgoingAggreGateCommand

**–ü—Ä–æ–±–ª–µ–º–∞:**
```java
// OutgoingAggreGateCommand.java:58-59
if (size() + paramBytes.length > buf.length)
    buf = Arrays.copyOf(buf, buf.length + paramBytes.length);
```

**–í–ª–∏—è–Ω–∏–µ:**
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Å—Å–∏–≤–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –õ–∏–Ω–µ–π–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å O(n¬≤) –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã
- –ö–∞–∂–¥–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —É–¥–≤–æ–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –±—É—Ñ–µ—Ä–∞
- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ü–µ–Ω–∫–∏

### 4. Command –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç ByteArrayOutputStream

**–ü—Ä–æ–±–ª–µ–º–∞:**
```java
// Command.java:15
public abstract class Command extends ByteArrayOutputStream
```

**–í–ª–∏—è–Ω–∏–µ:**
- `ByteArrayOutputStream` –∏–º–µ–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±—É—Ñ–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞—Å—Ç–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã –±—É—Ñ–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω–æ –±–æ–ª—å—à–∏–º
- –ù–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ —Ä–∞–∑–º–µ—Ä–æ–º –±—É—Ñ–µ—Ä–∞

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–∑–∏—Ü–∏—é –≤–º–µ—Å—Ç–æ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
- –£–ø—Ä–∞–≤–ª—è—Ç—å –±—É—Ñ–µ—Ä–æ–º –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `ByteBuffer` –∏–ª–∏ –º–∞—Å—Å–∏–≤ –±–∞–π—Ç

### 5. –°–æ–∑–¥–∞–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ String –æ–±—ä–µ–∫—Ç–æ–≤ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
```java
// IncomingAggreGateCommand.java:60
parameters = StringWrapper.split(getContent(), AggreGateCommand.CLIENT_COMMAND_SEPARATOR.charAt(0));
// IncomingAggreGateCommand.java:105
parameters.add(StringWrapper.valueOf(new String(buf, position, b.position() - position - 1, StringUtils.UTF8_CHARSET)));
```

**–í–ª–∏—è–Ω–∏–µ:**
- –ö–∞–∂–¥—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π `String` –æ–±—ä–µ–∫—Ç
- –î–ª—è –±–æ–ª—å—à–∏—Ö –∫–æ–º–∞–Ω–¥ (100+ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤) —ç—Ç–æ —Å–æ–∑–¥–∞–µ—Ç —Å–æ—Ç–Ω–∏ –æ–±—ä–µ–∫—Ç–æ–≤
- `StringWrapper` –¥–æ–±–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∏–Ω–¥–∏—Ä–µ–∫—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `CharSequence` –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥—Å—Ç—Ä–æ–∫ –±–µ–∑ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
- –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å—Ç—Ä–æ–∫–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É–ª —Å—Ç—Ä–æ–∫ –¥–ª—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∑–Ω–∞—á–µ–Ω–∏–π

### 6. –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ –≤ BufferedCommandParser

**–ü—Ä–æ–±–ª–µ–º–∞:**
```java
// BufferedCommandParser.java:16-18
private static final int BUFFER_SIZE = 1024;
protected final ByteBuffer buffer = ByteBuffer.allocate(BUFFER_SIZE);
```

**–í–ª–∏—è–Ω–∏–µ:**
- –ë—É—Ñ–µ—Ä —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ 1KB
- –î–ª—è –±–æ–ª—å—à–∏—Ö –∫–æ–º–∞–Ω–¥ —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á—Ç–µ–Ω–∏–µ
- –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–ª—è –∫–æ–º–∞–Ω–¥ —Ä–∞–∑–º–µ—Ä–æ–º > 1KB

**–†–µ—à–µ–Ω–∏–µ:**
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä—è–º—ã—Ö –±—É—Ñ–µ—Ä–æ–≤ –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫–æ–º–∞–Ω–¥

### 7. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ ByteBuffer.allocate

**–ü—Ä–æ–±–ª–µ–º–∞:**
```java
// CommandData.java:121
contents = ByteBuffer.allocate(length - typeByte);
// CompressedCommandWriter.java:66
ByteBuffer byteBuffer = ByteBuffer.allocate(lengthInBytes + bodyLength);
// Command.java:95
ByteBuffer buff = ByteBuffer.allocate(size);
```

**–í–ª–∏—è–Ω–∏–µ:**
- –ö–∞–∂–¥–∞—è –∫–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ `ByteBuffer`
- –ù–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±—É—Ñ–µ—Ä–æ–≤
- –ü—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ —ç—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —á–∞—Å—Ç—ã–º –∞–ª–ª–æ–∫–∞—Ü–∏—è–º

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É–ª –±—É—Ñ–µ—Ä–æ–≤ (`BufferPool`)
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±—É—Ñ–µ—Ä—ã –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏

## üü° –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 8. –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –±–æ–ª—å—à–∏–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**
```java
// IncomingAggreGateCommand.java:92-129
private void parseBigCommand()
{
    ByteBuffer b = ByteBuffer.wrap(buf);
    // –°–æ–∑–¥–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ String –æ–±—ä–µ–∫—Ç–æ–≤
}
```

**–í–ª–∏—è–Ω–∏–µ:**
- –î–ª—è –±–æ–ª—å—à–∏—Ö –∫–æ–º–∞–Ω–¥ —Å–æ–∑–¥–∞–µ—Ç—Å—è –º–Ω–æ–≥–æ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
- –ù–µ—Ç –ø–æ—Ç–æ–∫–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫–æ–≤—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫–æ–º–∞–Ω–¥
- –ò–∑–±–µ–≥–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª–Ω–æ–π –∫–æ–ø–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏

### 9. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–∞ —Ä–∞–∑–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–º–∞–Ω–¥—ã
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ `OutOfMemoryError` –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö –∫–æ–º–∞–Ω–¥

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100MB)
- –û—Ç–∫–ª–æ–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—ã, –ø—Ä–µ–≤—ã—à–∞—é—â–∏–µ –ª–∏–º–∏—Ç

### 10. –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å JSON

**–ü—Ä–æ–±–ª–µ–º–∞:**
```java
// IncomingAggreGateCommand.java:72-90
private void parseJsonCommand() throws SyntaxErrorException
{
    JSONParser json = new JSONParser();
    Object result = json.parse(getContent());
    // –°–æ–∑–¥–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤
}
```

**–í–ª–∏—è–Ω–∏–µ:**
- `JSONParser` —Å–æ–∑–¥–∞–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
- –ü–∞—Ä—Å–∏–Ω–≥ —Å–æ–∑–¥–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `JSONParser` (ThreadLocal)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π JSON –ø–∞—Ä—Å–µ—Ä (Jackson, Gson)

## üìà –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### 1.1. –ü—É–ª –±—É—Ñ–µ—Ä–æ–≤ –¥–ª—è ByteArrayOutputStream

```java
public class BufferPool {
    private static final ThreadLocal<ByteArrayOutputStream> pool = 
        ThreadLocal.withInitial(() -> new ByteArrayOutputStream(4096));
    
    public static ByteArrayOutputStream acquire() {
        ByteArrayOutputStream stream = pool.get();
        stream.reset();
        return stream;
    }
    
    public static void release(ByteArrayOutputStream stream) {
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º acquire
    }
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ –∞–ª–ª–æ–∫–∞—Ü–∏–π –Ω–∞ 80-90%

#### 1.2. ThreadLocal –¥–ª—è Inflater

```java
// AggreGateCommandParser.java
private final ThreadLocal<Inflater> decompressor = 
    ThreadLocal.withInitial(() -> {
        Inflater inf = new Inflater();
        return inf;
    });

protected IncomingAggreGateCommand buildCommandFrom(CommandData commandData) {
    Inflater localDecompressor = decompressor.get();
    localDecompressor.reset();
    // ... –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å—é, —Å–Ω–∏–∂–µ–Ω–∏–µ –∞–ª–ª–æ–∫–∞—Ü–∏–π

#### 1.3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –±—É—Ñ–µ—Ä–æ–≤

```java
// OutgoingAggreGateCommand.java
private void ensureCapacity(int minCapacity) {
    if (minCapacity > buf.length) {
        int newCapacity = Math.max(buf.length * 2, minCapacity);
        buf = Arrays.copyOf(buf, newCapacity);
    }
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–π –Ω–∞ 50-70%

#### 1.4. –ü—É–ª ByteBuffer

```java
public class ByteBufferPool {
    private static final int MAX_POOL_SIZE = 100;
    private final Queue<ByteBuffer> pool = new ConcurrentLinkedQueue<>();
    
    public ByteBuffer acquire(int size) {
        ByteBuffer buffer = pool.poll();
        if (buffer == null || buffer.capacity() < size) {
            return ByteBuffer.allocate(size);
        }
        buffer.clear();
        return buffer;
    }
    
    public void release(ByteBuffer buffer) {
        if (pool.size() < MAX_POOL_SIZE && buffer.capacity() <= 64 * 1024) {
            pool.offer(buffer);
        }
    }
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ –∞–ª–ª–æ–∫–∞—Ü–∏–π ByteBuffer –Ω–∞ 60-80%

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –°—Ä–µ–¥–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### 2.1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CharSequence –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

```java
// –í–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è String –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
public class StringWrapper implements CharSequence {
    private final byte[] data;
    private final int offset;
    private final int length;
    
    // –ò–∑–±–µ–≥–∞–µ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ –∞–ª–ª–æ–∫–∞—Ü–∏–π String –Ω–∞ 40-50%

#### 2.2. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞

```java
// BufferedCommandParser.java
private static final int INITIAL_BUFFER_SIZE = 1024;
private static final int MAX_BUFFER_SIZE = 64 * 1024 * 1024; // 64MB

protected ByteBuffer buffer = ByteBuffer.allocate(INITIAL_BUFFER_SIZE);

private void ensureBufferCapacity(int required) {
    if (buffer.capacity() < required) {
        int newSize = Math.min(buffer.capacity() * 2, MAX_BUFFER_SIZE);
        if (newSize < required) {
            newSize = required;
        }
        ByteBuffer newBuffer = ByteBuffer.allocate(newSize);
        buffer.flip();
        newBuffer.put(buffer);
        buffer = newBuffer;
    }
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏–π –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫–æ–º–∞–Ω–¥

#### 2.3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–º–∞–Ω–¥—ã

```java
// AggreGateCommandParser.java
private static final int MAX_COMMAND_SIZE = 100 * 1024 * 1024; // 100MB

protected IncomingAggreGateCommand buildCommandFrom(CommandData commandData) {
    int length = commandData.getBody().getLength();
    if (length > MAX_COMMAND_SIZE) {
        throw new SyntaxErrorException("Command size exceeds maximum: " + length);
    }
    // ...
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –ó–∞—â–∏—Ç–∞ –æ—Ç OutOfMemoryError

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### 3.1. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ JSONParser

```java
private final ThreadLocal<JSONParser> jsonParser = 
    ThreadLocal.withInitial(JSONParser::new);
```

#### 3.2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä—è–º—ã—Ö –±—É—Ñ–µ—Ä–æ–≤ –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö

```java
// –î–ª—è –∫–æ–º–∞–Ω–¥ > 64KB –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π –±—É—Ñ–µ—Ä
if (size > 64 * 1024) {
    buffer = ByteBuffer.allocateDirect(size);
}
```

#### 3.3. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å—Ç—Ä–æ–∫

```java
private static final Map<String, String> stringCache = 
    new ConcurrentHashMap<>(1000);

private String internString(String str) {
    if (str.length() < 50) { // –ö—ç—à–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∫–æ—Ä–æ—Ç–∫–∏–µ —Å—Ç—Ä–æ–∫–∏
        return stringCache.computeIfAbsent(str, k -> k);
    }
    return str;
}
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- **–ü–∞–º—è—Ç—å –Ω–∞ –∫–æ–º–∞–Ω–¥—É:** ~2-5KB (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞)
- **–ê–ª–ª–æ–∫–∞—Ü–∏–∏ –Ω–∞ –∫–æ–º–∞–Ω–¥—É:** 10-20 –æ–±—ä–µ–∫—Ç–æ–≤
- **GC –ø–∞—É–∑—ã:** –ß–∞—Å—Ç—ã–µ (–∫–∞–∂–¥—ã–µ 1-2 —Å–µ–∫—É–Ω–¥—ã –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ)

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- **–ü–∞–º—è—Ç—å –Ω–∞ –∫–æ–º–∞–Ω–¥—É:** ~1-2KB (—Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 50-60%)
- **–ê–ª–ª–æ–∫–∞—Ü–∏–∏ –Ω–∞ –∫–æ–º–∞–Ω–¥—É:** 2-5 –æ–±—ä–µ–∫—Ç–æ–≤ (—Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 75-80%)
- **GC –ø–∞—É–∑—ã:** –†–µ–¥–∫–∏–µ (–∫–∞–∂–¥—ã–µ 10-20 —Å–µ–∫—É–Ω–¥)

## üîß –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –≠—Ç–∞–ø 1 (1-2 –Ω–µ–¥–µ–ª–∏)
1. –í–Ω–µ–¥—Ä–∏—Ç—å ThreadLocal –¥–ª—è Inflater
2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤ –≤ OutgoingAggreGateCommand
3. –î–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —Ä–∞–∑–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã

### –≠—Ç–∞–ø 2 (2-3 –Ω–µ–¥–µ–ª–∏)
4. –í–Ω–µ–¥—Ä–∏—Ç—å –ø—É–ª ByteArrayOutputStream
5. –í–Ω–µ–¥—Ä–∏—Ç—å –ø—É–ª ByteBuffer
6. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å BufferedCommandParser

### –≠—Ç–∞–ø 3 (3-4 –Ω–µ–¥–µ–ª–∏)
7. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CharSequence –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
8. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JSONParser
9. –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Ç—â–∞—Ç–µ–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
4. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ:** –í–Ω–µ–¥—Ä—è—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—ç—Ç–∞–ø–Ω–æ —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º

## üìù –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–ª–ª–æ–∫–∞—Ü–∏–π –≤ —Å–µ–∫—É–Ω–¥—É
- –†–∞–∑–º–µ—Ä heap –ø–∞–º—è—Ç–∏
- –ß–∞—Å—Ç–æ—Ç–∞ –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å GC –ø–∞—É–∑
- –†–∞–∑–º–µ—Ä –∫–æ–º–∞–Ω–¥ (—Å—Ä–µ–¥–Ω–∏–π, –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –±—É—Ñ–µ—Ä–æ–≤

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 2024-12-XX*  
*–í–µ—Ä—Å–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞: V2, V3, V4*

